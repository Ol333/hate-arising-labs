# RefineDet

## Кто предложил

S. Zhang, L. Wen, X. Bian, Z. Lei and S. Z. Li, "Single-Shot Refinement Neural Network for Object Detection," 2018 IEEE/CVF Conference on Computer Vision and Pattern Recognition, Salt Lake City, UT, USA, 2018, pp. 4203-4212, doi: 10.1109/CVPR.2018.00442. URL: [https://arxiv.org/abs/1711.06897](https://arxiv.org/abs/1711.06897)

## Описание модели

Для обнаружения объектов двухэтапный подход (например, Faster R-CNN) обеспечивает наивысшую точность, тогда как одноэтапный подход (например, SSD) имеет преимущество в виде высокой эффективности. Чтобы унаследовать достоинства обоих методов, преодолевая их недостатки, в этой статье мы предлагаем новый детектор на основе однократного срабатывания, называемый RefineDet, который достигает лучшей точности, чем двухэтапные методы, и сохраняет сопоставимую эффективность одноэтапных методов. RefineDet состоит из двух взаимосвязанных модулей, а именно, модуля уточнения якорей и модуля обнаружения объектов. В частности, первый нацелен на (1) фильтрацию отрицательных якорей для сокращения пространства поиска для классификатора и (2) грубую настройку местоположений и размеров якорей для обеспечения лучшей инициализации для последующего регрессора. Последний модуль принимает уточненные якоря в качестве входных данных из первого для дальнейшего улучшения регрессии и прогнозирования многоклассовой метки. Между тем, мы проектируем блок передачи соединения для передачи признаков в модуле уточнения якоря для прогнозирования местоположений, размеров и меток классов объектов в модуле обнаружения объектов. Функция многозадачных потерь позволяет нам обучать всю сеть сквозным способом. Обширные эксперименты на PASCAL VOC 2007, PASCAL VOC 2012 и MS COCO демонстрируют, что RefineDet достигает точности обнаружения на самом современном уровне с высокой эффективностью.

<div class="card border-primary mb-2" style="max-width: 50rem;">
  <div class="card-body">
    <img src="{{ site.baseurl }}/artificial-intelligence/pattern-recognition/labs/lab3_data/images2/schema.png"
        alt="Архитектура RefineDet" focusable="false" width="100%"
        class="d-block user-select-none" />
  </div>
</div>

На изображении показана архитектура RefineDet с двумя основными модулями: ARM и ODM. Параллелограммы обозначают уточненные якоря, связанные с различными слоями объектов. Звезды обозначают центры уточненных якорных рамок после обработки в ARM. В отличие от исходных якорей, которые равномерно распределены по изображению, центры уточненных якорей могут быть расположены неравномерно, поскольку они смещены в направлении истинных позиций объектов. Это означает, что после предварительной регрессии в ARM якорные рамки лучше выровнены с объектами, что облегчает последующее обнаружение в ODM.

Подобно SSD, RefineDet создает фиксированное количество ограничивающих рамок и оценок, указывающих на наличие различных классов объектов в этих рамках, после чего применяется подавление немаксимальных значений (NMS) для получения окончательного результата.
RefineDet состоит из двух взаимосвязанных модулей: модуля уточнения якоря (ARM) и модуля обнаружения объектов (ODM).
В качестве основы используются предварительно обученные VGG -16 и ResNet -101 ILSVRC CLS-LOC .

## Модуль уточнения якорей (Anchor Refinement Module, ARM)

ARM выполняет две основные задачи:

1. Фильтрация отрицательных якорей: Отбрасывает якоря, которые с высокой уверенностью принадлежат фону, сокращая тем самым пространство поиска для классификатора в ODM.

2. Грубое уточнение якорей: Регрессирует смещения позиций и размеров положительных якорей, чтобы обеспечить лучшую инициализацию для последующего модуля ODM.

В стандартных одноэтапных детекторах, таких как SSD, якорные рамки (anchors) равномерно распределены по изображению и имеют фиксированные размеры и соотношения сторон. Однако это может приводить к большому количеству отрицательных якорей (т.е. якорей, которые не перекрываются с объектами), что усложняет обучение.

Детали работы ARM:

* Фильтрация отрицательных якорей: ARM обучается предсказывать вероятность того, что якорь содержит объект (передний план) или фон (задний план). Если вероятность принадлежности якоря к фону превышает заданный порог (например, 0,99), этот якорь отбрасывается и не передается в ODM. Это позволяет сократить количество отрицательных примеров, с которыми должен работать ODM.

* Регрессия смещений: Для каждого положительного якоря (т.е. якоря, который перекрывается с объектом) ARM прогнозирует смещения по координатам центра и размерам рамки, чтобы приблизить якорь к истинной позиции объекта. Это обеспечивает лучшую инициализацию для последующей точной регрессии в ODM.

## Модуль обнаружения объектов (Object Detection Module, ODM)

После обработки в ARM уточненные якоря передаются в ODM. Цель ODM — точно определить позиции объектов и классифицировать их.

Детали работы ODM:

* Дальнейшая регрессия позиций: ODM принимает уточненные якоря и выполняет более точную регрессию смещений, чтобы максимально приблизить предсказанные рамки к истинным границам объектов.

* Многоклассовая классификация: ODM предсказывает вероятности принадлежности объектов к различным классам. В отличие от ARM, который выполняет бинарную классификацию (объект/фон), ODM выполняет многоклассовую классификацию.

## Hard Negative Mining (Отбор сложных отрицательных примеров)

Hard Negative Mining — это техника, используемая для решения проблемы дисбаланса классов между положительными и отрицательными примерами при обучении детекторов объектов. В контексте RefineDet, даже после фильтрации отрицательных якорей в ARM, в ODM может оставаться значительное количество отрицательных якорей, которые не содержат объектов, но все еще могут приводить к ложным срабатываниям.

При обучении модели количество отрицательных примеров (фон) обычно значительно превышает количество положительных примеров (объекты). Это может привести к тому, что модель будет склонна предсказывать фон и игнорировать объекты.

Вместо того чтобы использовать все отрицательные примеры или выбирать их случайным образом, выбираются только те отрицательные якоря, которые модель классифицирует с наибольшей неуверенностью или которые дают наибольшую ошибку (т.е. с наибольшей функцией потерь). Это означает, что модель фокусируется на "сложных" отрицательных примерах, которые она склонна ошибочно классифицировать как объекты.

Соотношение отрицательных и положительных примеров: Обычно устанавливается фиксированное соотношение между количеством отрицательных и положительных примеров (например, 3:1). Это позволяет контролировать количество отрицательных примеров и предотвращает доминирование отрицательных примеров в общей функции потерь.

## Блок передачи соединения (Transfer Connection Block, TCB)

<div class="card border-primary mb-2" style="max-width: 15rem;">
  <div class="card-body">
    <img src="{{ site.baseurl }}/artificial-intelligence/pattern-recognition/labs/lab3_data/images2/block.png"
        alt="" focusable="false" width="100%"
        class="d-block user-select-none" />
  </div>
</div>

TCB (Transfer Connection Block) используется для передачи и обработки признаков между ARM и ODM. Он выполняет следующие функции:

* Интеграция контекстной информации: TCB объединяет признаки из разных уровней карты признаков, чтобы обеспечить модель более богатой информацией для обнаружения объектов. Это особенно важно для обнаружения объектов разных размеров и масштабов.

* Выравнивание размерностей признаков: Поскольку признаки из разных уровней карты признаков могут иметь разные размерности и разрешения, TCB использует операции деконволюции (обратной свертки) для увеличения размера высокоуровневых карт признаков и приведения их к одному размеру с низкоуровневыми признаками. Затем они суммируются поэлементно.

Карта признаков (Feature Map) — это многомерный массив (тензор), который представляет активность нейронной сети на определенном уровне глубины. В контексте сверточных нейронных сетей, карты признаков — это результаты применения фильтров (сверток) к входным данным или предыдущим картам признаков. Они содержат пространственную информацию об обнаруженных признаках (например, краях, углах, текстурах) на изображении и используются для дальнейшего обучения и прогнозирования.

## Функция потерь

Общая функция потерь для RefineDet состоит из двух частей: потерь в ARM и потерь в ODM.

Функция потерь записывается как:

$ L = L_{arm} + L_{odm} $

Где:
- $ L_{arm} $ — функция потерь для ARM.
- $ L_{odm} $ — функция потерь для ODM.

### Функция потерь для ARM

Функция потерь для ARM определяется как:

$ L_{arm} = \frac{1}{N_{arm}} \left( \sum_i L_b(c_i, c_i^\*) + [l_i^* \geq 1] L_r(t_i, t_i^*) \right) $

### Функция потерь для ODM

Функция потерь для ODM определяется как:

$ L_{odm} = \frac{1}{N_{odm}} \left( \sum_i L_m(c_i, c_i^\*) + [ l_i^* \geq 1 ] L_r(t_i, t_i^*) \right) $

### Где:

- $ N_{arm} $ и $ N_{odm} $ — количество положительных якорей в ARM и ODM соответственно.
- $ L_b(c_i, c_i^\*) $ — бинарная функция потерь классификации (бинарная кросс-энтропия) между предсказанной меткой $ c_i $ и истинной меткой $ c_i^* $ (объект/фон) в ARM.
- $ L_m(c_i, c_i^\*) $ — функция потерь многоклассовой классификации (softmax-кросс-энтропия) между предсказанной меткой $ c_i $ и истинной меткой $ c_i^* $ в ODM.
- $ L_r(t_i, t_i^\*) $ — функция потерь регрессии (сглаженная L1-потеря) между предсказанными смещениями $ t_i $ и истинными смещениями $ t_i^* $.
- $ [l_i^* \geq 1] $ — индикаторная функция, равная 1, если якорь является положительным (т.е. перекрывается с объектом), и 0 в противном случае. Это означает, что регрессионная потеря вычисляется только для положительных якорей.


## Вывод

Процесс вывода (инференса) в модели RefineDet состоит из следующих шагов:

1. Предсказание в ARM: ARM обрабатывает входное изображение и предсказывает вероятности принадлежности якорей к объектам или фону, а также смещения позиций и размеров для уточнения якорей.

2. Фильтрация отрицательных якорей: Якоря, которые ARM классифицирует с высокой уверенностью как фон (отрицательные примеры с вероятностью более 0,99), отбрасываются и не передаются в ODM.

3. Передача уточненных якорей в ODM: Оставшиеся якоря (как положительные, так и отрицательные с низкой уверенностью) передаются в ODM для дальнейшей обработки.

4. Предсказание в ODM: ODM выполняет более точную регрессию смещений и предсказывает вероятности принадлежности объектов к различным классам.

5. Подавление немаксимумов (Non-Maximum Suppression, NMS): Для устранения перекрывающихся предсказаний применяется алгоритм NMS с заданным порогом перекрытия (например, 0,45). Это позволяет сохранить только наиболее достоверные и не перекрывающиеся рамки объектов.

6. Формирование финальных результатов: Выбираются наиболее достоверные предсказания (например, топ-200) для каждого изображения, которые представляют собой финальные результаты обнаружения объектов.

## Страничка авторов на GitHub 

[исходники](https://github.com/sfzhang15/RefineDet)

## Пример работы
Качественные результаты RefineDet512 на тестовом наборе PASCAL VOC 2007

<div class="card border-primary mb-2" style="max-width: 50rem;">
  <div class="card-body">
    <img src="{{ site.baseurl }}/artificial-intelligence/pattern-recognition/labs/lab3_data/images2/Results.png"
        alt="" focusable="false" width="100%"
        class="d-block user-select-none" />
  </div>
</div>


*Последняя версия: Гавриленко М.Т.*